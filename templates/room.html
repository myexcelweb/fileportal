<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Room {{ code }} - File Transfer</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">

    <!-- Socket.IO Client Library -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.7.4/socket.io.js"></script>

    <!-- QR Code Library (Lightweight) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>

    <style>
        /* Inline style for the danger button to ensure it looks red immediately */
        .btn-danger {
            background: linear-gradient(135deg, #ff416c 0%, #ff4b2b 100%);
            color: white;
            width: 100%;
            padding: 15px;
            border: none;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            margin-bottom: 10px;
            transition: all 0.3s;
        }

        .btn-danger:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(255, 75, 43, 0.4);
        }

        .home-link {
            display: block;
            text-align: center;
            color: #666;
            text-decoration: none;
            font-weight: 500;
            margin-top: 10px;
        }

        .home-link:hover {
            text-decoration: underline;
        }
    </style>
</head>

<body data-room-code="{{ code }}" data-current-user="{{ current_user }}"
    data-remaining-seconds="{{ remaining_seconds }}">

    <div class="container">
        <h1>üîê Room {{ code }}</h1>
        <p class="subtitle">Share this code or scan QR to transfer files</p>

        <!-- Timer & Code Section -->
        <div class="card">
            <div class="timer-container">
                <div class="timer-label">Room expires in:</div>
                <div class="countdown-timer">
                    <div id="timer-display">{{ remaining_seconds // 60 }}:{{ '%02d' % (remaining_seconds % 60) }}</div>
                </div>
                <div id="timer-warning" class="timer-warning" style="display: none;">
                    ‚ö†Ô∏è Less than 2 minutes remaining!
                </div>
            </div>

            <div class="code-display-small">{{ code }}</div>

            <!-- QR Code Container -->
            <div id="qrcode-container"
                style="display: flex; flex-direction: column; align-items: center; margin: 15px 0; padding: 10px; background: #fff; border-radius: 10px;">
                <div id="qrcode"></div>
                <p
                    style="margin-top: 10px; font-size: 12px; color: #888; font-weight: bold; text-transform: uppercase;">
                    Scan to Join</p>
            </div>

            <button class="btn-copy-small" onclick="copyCode()">üìã Copy Room Code</button>
            <button class="btn-copy-small" onclick="copyLink()"
                style="margin-top: 8px; background: #4a90e2; width: 100%;">üîó Copy Direct Link</button>
            <p class="info">Share this code with others to join this room</p>
        </div>

        <!-- Upload Section -->
        <div class="card">
            <h2>üì§ Upload Files</h2>
            <form action="{{ url_for('upload_file', code=code) }}" method="POST" enctype="multipart/form-data"
                id="uploadForm">
                <div class="file-input-wrapper">
                    <input type="file" name="file" id="file-input" multiple required>
                    <label for="file-input" class="file-label">
                        üìÅ Choose Files (Max 100MB total)
                    </label>
                </div>
                <div id="file-list" class="file-list"></div>
                <button type="submit" class="btn btn-primary">Upload Files</button>
            </form>
            <div class="info">Multiple files supported ‚Ä¢ Auto-delete after 15 minutes</div>
        </div>

        <!-- Files Section -->
        <div class="card">
            <h2>üì• Available Files (<span id="file-count">{{ files|length }}</span>)</h2>

            {% if files %}
            <div id="download-all-container">
                <a href="{{ url_for('download_all', code=code) }}" class="btn btn-download">
                    üì¶ Download All as ZIP
                </a>
            </div>

            <div id="files-container">
                {% for file in files %}
                <div class="file-item" data-index="{{ loop.index0 }}">
                    <div class="file-icon">üìÑ</div>
                    <div class="file-info">
                        <div class="file-name">{{ file.original_name }}</div>
                        <div class="file-meta">
                            <span class="file-type">{{ file.type }}</span>
                            <span class="file-size">{{ file.size }}</span>
                            {% if file.sender == current_user %}
                            <span class="file-sender-badge">You</span>
                            {% endif %}
                        </div>
                    </div>
                    <a href="{{ url_for('download_file', code=code, index=loop.index0) }}" class="btn-icon"
                        title="Download">‚¨áÔ∏è</a>
                </div>
                {% endfor %}
            </div>
            {% else %}
            <div id="no-files-message" class="info">No files uploaded yet. Be the first to share!</div>
            {% endif %}
        </div>

        <!-- Activity History -->
        <div class="card">
            <h3>üìä Activity History</h3>
            <div id="history-container" class="history-list">
                {% for entry in history %}
                <div class="history-item">
                    <span class="history-time">{{ entry.time }}</span>
                    <span class="history-action">{{ entry.action }}</span>
                    {% if entry.user == current_user %}
                    <span class="history-user">(You)</span>
                    {% endif %}
                </div>
                {% endfor %}
            </div>
        </div>

        <!-- üü¢ EXIT & DELETE SECTION -->
        <div class="card" style="border: 2px solid #ffebee;">
            <h3 style="color: #c62828;">‚ö†Ô∏è Danger Zone</h3>
            <p class="info" style="margin-bottom: 15px;">Delete the room and all files immediately.</p>

            <form action="{{ url_for('destroy_room', code=code) }}" method="POST"
                onsubmit="return confirm('‚ö†Ô∏è Are you sure? This will delete the room and ALL files immediately. This action cannot be undone.');">
                <button type="submit" class="btn-danger">‚ùå Exit & Delete Room Data</button>
            </form>

            <a href="{{ url_for('index') }}" class="home-link">‚¨ÖÔ∏è Go Home (Keep Room Open)</a>
        </div>
    </div>

    <script>
        // Get configuration from data attributes
        var roomCode = document.body.getAttribute('data-room-code');
        var currentUser = document.body.getAttribute('data-current-user');
        var remainingSeconds = parseInt(document.body.getAttribute('data-remaining-seconds'));

        // Initialize Socket.IO
        var socket = io();

        // üü¢ QR CODE GENERATION
        // We use the /j/ route if available, otherwise fallback to standard URL
        var joinUrl = window.location.origin + "/j/" + roomCode;

        try {
            new QRCode(document.getElementById("qrcode"), {
                text: joinUrl,
                width: 128,
                height: 128,
                colorDark: "#000000",
                colorLight: "#ffffff",
                correctLevel: QRCode.CorrectLevel.H
            });
        } catch (e) {
            console.error("QR Code library not loaded", e);
            document.getElementById("qrcode-container").style.display = "none";
        }

        // üü¢ COPY LINK FUNCTION
        function copyLink() {
            navigator.clipboard.writeText(joinUrl).then(function () {
                alert("Link copied to clipboard!\nShare this with others to join instantly.");
            }).catch(function (err) {
                console.error('Could not copy text: ', err);
            });
        }

        // Join the room via Socket.IO
        socket.on('connect', function () {
            console.log('Connected to server');
            socket.emit('join', { code: roomCode });
        });

        // üü¢ HANDLE ROOM DESTRUCTION (Force Redirect)
        socket.on('room_destroyed', function () {
            alert('üö´ This room has been closed and all files deleted.');
            window.location.href = '/';
        });

        // Handle new files uploaded by other users
        socket.on('new_files', function (data) {
            console.log('New files received:', data);

            // Remove "no files" message if it exists
            var noFilesMsg = document.getElementById('no-files-message');
            if (noFilesMsg) {
                noFilesMsg.remove();
            }

            // Get or create files container
            var filesContainer = document.getElementById('files-container');
            if (!filesContainer) {
                filesContainer = document.createElement('div');
                filesContainer.id = 'files-container';
                var parentCard = document.querySelector('#file-count').closest('.card');

                // Add download all button if it doesn't exist
                var downloadAllContainer = document.getElementById('download-all-container');
                if (!downloadAllContainer) {
                    downloadAllContainer = document.createElement('div');
                    downloadAllContainer.id = 'download-all-container';
                    downloadAllContainer.innerHTML = '<a href="/download_all/' + roomCode + '" class="btn btn-download">üì¶ Download All as ZIP</a>';
                    parentCard.appendChild(downloadAllContainer);
                }

                parentCard.appendChild(filesContainer);
            }

            // Add each new file to the list
            data.files.forEach(function (file) {
                var fileItem = createFileElement(file);
                filesContainer.insertAdjacentHTML('beforeend', fileItem);
            });

            // Update file count
            updateFileCount();
        });

        // Handle file download notifications
        socket.on('file_downloaded', function (data) {
            if (data.user !== currentUser) {
                console.log('File downloaded: ' + data.filename);
            }
        });

        // Create file element HTML
        function createFileElement(file) {
            var isSender = file.sender === currentUser;
            var senderBadge = isSender ? '<span class="file-sender-badge">You</span>' : '';

            return '<div class="file-item" data-index="' + file.index + '">' +
                '<div class="file-icon">üìÑ</div>' +
                '<div class="file-info">' +
                '<div class="file-name">' + file.original_name + '</div>' +
                '<div class="file-meta">' +
                '<span class="file-type">' + file.type + '</span>' +
                '<span class="file-size">' + file.size + '</span>' +
                senderBadge +
                '</div>' +
                '</div>' +
                '<a href="/download/' + roomCode + '/' + file.index + '" class="btn-icon" title="Download">‚¨áÔ∏è</a>' +
                '</div>';
        }

        // Update file count
        function updateFileCount() {
            var fileItems = document.querySelectorAll('.file-item');
            document.getElementById('file-count').textContent = fileItems.length;
        }

        // File input display
        document.getElementById('file-input').addEventListener('change', function (e) {
            var fileList = document.getElementById('file-list');
            fileList.innerHTML = '';

            if (e.target.files.length > 0) {
                var listContainer = document.createElement('div');
                listContainer.style.cssText = 'margin: 10px 0; padding: 10px; background: #f5f5f5; border-radius: 8px;';

                Array.from(e.target.files).forEach(function (file) {
                    var fileItem = document.createElement('div');
                    fileItem.style.cssText = 'padding: 5px 0; color: #666; font-size: 14px;';
                    fileItem.textContent = 'üìÑ ' + file.name + ' (' + (file.size / 1024 / 1024).toFixed(2) + ' MB)';
                    listContainer.appendChild(fileItem);
                });

                fileList.appendChild(listContainer);
            }
        });

        // Copy code function
        function copyCode() {
            navigator.clipboard.writeText(roomCode).then(function () {
                var btn = event.target;
                var originalText = btn.textContent;
                btn.textContent = '‚úì Copied!';
                btn.style.background = '#4CAF50';

                setTimeout(function () {
                    btn.textContent = originalText;
                    btn.style.background = '#667eea';
                }, 2000);
            });
        }

        // Timer countdown
        function updateTimer() {
            if (remainingSeconds <= 0) {
                document.getElementById('timer-display').textContent = 'EXPIRED';
                document.getElementById('timer-display').style.color = '#c62828';
                alert('Room has expired! Files will be deleted.');
                window.location.href = '/';
                return;
            }

            var minutes = Math.floor(remainingSeconds / 60);
            var seconds = remainingSeconds % 60;
            document.getElementById('timer-display').textContent =
                minutes + ':' + (seconds < 10 ? '0' : '') + seconds;

            if (remainingSeconds <= 120) {
                document.getElementById('timer-display').style.color = '#f57c00';
                document.getElementById('timer-warning').style.display = 'block';
            }

            if (remainingSeconds <= 30) {
                document.getElementById('timer-display').style.color = '#c62828';
            }

            remainingSeconds--;
        }

        // Start timer
        setInterval(updateTimer, 1000);

        // Handle page unload
        window.addEventListener('beforeunload', function () {
            socket.emit('leave', { code: roomCode });
        });
    </script>

    <footer class="footer">
        <p>
            Contact: <a href="mailto:parimalhodar.dev@gmail.com">parimalhodar.dev@gmail.com</a> |
            Designed & Developed by <strong>Parimal Hodar</strong>
        </p>
    </footer>

</body>

</html>