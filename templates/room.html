<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Room {{ code }} - File Transfer</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <!-- Socket.IO Client Library -->
    <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
</head>

<body data-room-code="{{ code }}" data-current-user="{{ current_user }}"
    data-remaining-seconds="{{ remaining_seconds }}">
    <div class="container">
        <h1>üîê Room {{ code }}</h1>
        <p class="subtitle">Share this code with others to transfer files</p>

        <!-- Timer Section -->
        <div class="card">
            <div class="timer-container">
                <div class="timer-label">Room expires in:</div>
                <div class="countdown-timer">
                    <div id="timer-display">{{ remaining_seconds // 60 }}:{{ '%02d' % (remaining_seconds % 60) }}</div>
                </div>
                <div id="timer-warning" class="timer-warning" style="display: none;">
                    ‚ö†Ô∏è Less than 2 minutes remaining!
                </div>
            </div>

            <div class="code-display-small">{{ code }}</div>
            <button class="btn-copy-small" onclick="copyCode()">üìã Copy Code</button>
            <p class="info">Share this code with others to join this room</p>
        </div>

        <!-- Upload Section -->
        <div class="card">
            <h2>üì§ Upload Files</h2>
            <form action="{{ url_for('upload_file', code=code) }}" method="POST" enctype="multipart/form-data"
                id="uploadForm">
                <div class="file-input-wrapper">
                    <input type="file" name="file" id="file-input" multiple required>
                    <label for="file-input" class="file-label">
                        üìÅ Choose Files (Max 100MB total)
                    </label>
                </div>
                <div id="file-list" class="file-list"></div>
                <button type="submit" class="btn btn-primary">Upload Files</button>
            </form>
            <div class="info">Multiple files supported ‚Ä¢ Auto-delete after 15 minutes</div>
        </div>

        <!-- Files Section -->
        <div class="card">
            <h2>üì• Available Files (<span id="file-count">{{ files|length }}</span>)</h2>

            {% if files %}
            <div id="download-all-container">
                <a href="{{ url_for('download_all', code=code) }}" class="btn btn-download">
                    üì¶ Download All as ZIP
                </a>
            </div>

            <div id="files-container">
                {% for file in files %}
                <div class="file-item" data-index="{{ loop.index0 }}">
                    <div class="file-icon">üìÑ</div>
                    <div class="file-info">
                        <div class="file-name">{{ file.original_name }}</div>
                        <div class="file-meta">
                            <span class="file-type">{{ file.type }}</span>
                            <span class="file-size">{{ file.size }}</span>
                            {% if file.sender == current_user %}
                            <span class="file-sender-badge">You</span>
                            {% endif %}
                        </div>
                    </div>
                    <a href="{{ url_for('download_file', code=code, index=loop.index0) }}" class="btn-icon"
                        title="Download">‚¨áÔ∏è</a>
                </div>
                {% endfor %}
            </div>
            {% else %}
            <div id="no-files-message" class="info">No files uploaded yet. Be the first to share!</div>
            {% endif %}
        </div>

        <!-- Activity History -->
        <div class="card">
            <h3>üìä Activity History</h3>
            <div id="history-container" class="history-list">
                {% for entry in history %}
                <div class="history-item">
                    <span class="history-time">{{ entry.time }}</span>
                    <span class="history-action">{{ entry.action }}</span>
                    {% if entry.user == current_user %}
                    <span class="history-user">(You)</span>
                    {% endif %}
                </div>
                {% endfor %}
            </div>
        </div>

        <a href="{{ url_for('index') }}" class="btn btn-secondary">üè† Create New Room</a>
    </div>

    <script>
        // Get configuration from data attributes (avoids VSCode linting errors)
        var roomCode = document.body.getAttribute('data-room-code');
        var currentUser = document.body.getAttribute('data-current-user');
        var remainingSeconds = parseInt(document.body.getAttribute('data-remaining-seconds'));

        // Initialize Socket.IO
        var socket = io();

        // Join the room
        socket.on('connect', function () {
            console.log('Connected to server');
            socket.emit('join', { code: roomCode });
        });

        // Handle new files uploaded by other users
        socket.on('new_files', function (data) {
            console.log('New files received:', data);

            // Remove "no files" message if it exists
            var noFilesMsg = document.getElementById('no-files-message');
            if (noFilesMsg) {
                noFilesMsg.remove();
            }

            // Get or create files container
            var filesContainer = document.getElementById('files-container');
            if (!filesContainer) {
                filesContainer = document.createElement('div');
                filesContainer.id = 'files-container';
                var parentCard = document.querySelector('#file-count').closest('.card');

                // Add download all button if it doesn't exist
                var downloadAllContainer = document.getElementById('download-all-container');
                if (!downloadAllContainer) {
                    downloadAllContainer = document.createElement('div');
                    downloadAllContainer.id = 'download-all-container';
                    downloadAllContainer.innerHTML = '<a href="/download_all/' + roomCode + '" class="btn btn-download">üì¶ Download All as ZIP</a>';
                    parentCard.appendChild(downloadAllContainer);
                }

                parentCard.appendChild(filesContainer);
            }

            // Add each new file to the list
            data.files.forEach(function (file) {
                var fileItem = createFileElement(file);
                filesContainer.insertAdjacentHTML('beforeend', fileItem);

                // Add animation
                var newItem = filesContainer.lastElementChild;
                newItem.style.animation = 'slideIn 0.3s ease-out';
            });

            // Update file count
            updateFileCount();

            // Show notification if file was sent by another user
            if (data.sender !== currentUser) {
                showNotification('New file(s) uploaded!');
            }
        });

        // Handle file download notifications
        socket.on('file_downloaded', function (data) {
            if (data.user !== currentUser) {
                console.log('File downloaded: ' + data.filename);
            }
        });

        // Create file element HTML
        function createFileElement(file) {
            var isSender = file.sender === currentUser;
            var senderBadge = isSender ? '<span class="file-sender-badge">You</span>' : '';

            return '<div class="file-item" data-index="' + file.index + '">' +
                '<div class="file-icon">üìÑ</div>' +
                '<div class="file-info">' +
                '<div class="file-name">' + file.original_name + '</div>' +
                '<div class="file-meta">' +
                '<span class="file-type">' + file.type + '</span>' +
                '<span class="file-size">' + file.size + '</span>' +
                senderBadge +
                '</div>' +
                '</div>' +
                '<a href="/download/' + roomCode + '/' + file.index + '" class="btn-icon" title="Download">‚¨áÔ∏è</a>' +
                '</div>';
        }

        // Update file count
        function updateFileCount() {
            var fileItems = document.querySelectorAll('.file-item');
            document.getElementById('file-count').textContent = fileItems.length;
        }

        // Show notification
        function showNotification(message) {
            var notification = document.createElement('div');
            notification.className = 'notification';
            notification.textContent = message;
            notification.style.cssText = 'position: fixed; top: 20px; right: 20px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 15px 25px; border-radius: 12px; box-shadow: 0 5px 20px rgba(0, 0, 0, 0.3); z-index: 1000; animation: slideInRight 0.3s ease-out;';

            document.body.appendChild(notification);

            setTimeout(function () {
                notification.style.animation = 'slideOutRight 0.3s ease-out';
                setTimeout(function () {
                    notification.remove();
                }, 300);
            }, 3000);
        }

        // File input display
        document.getElementById('file-input').addEventListener('change', function (e) {
            var fileList = document.getElementById('file-list');
            fileList.innerHTML = '';

            if (e.target.files.length > 0) {
                var listContainer = document.createElement('div');
                listContainer.style.cssText = 'margin: 10px 0; padding: 10px; background: #f5f5f5; border-radius: 8px;';

                Array.from(e.target.files).forEach(function (file) {
                    var fileItem = document.createElement('div');
                    fileItem.style.cssText = 'padding: 5px 0; color: #666; font-size: 14px;';
                    fileItem.textContent = 'üìÑ ' + file.name + ' (' + (file.size / 1024 / 1024).toFixed(2) + ' MB)';
                    listContainer.appendChild(fileItem);
                });

                fileList.appendChild(listContainer);
            }
        });

        // Copy code function
        function copyCode() {
            navigator.clipboard.writeText(roomCode).then(function () {
                var btn = event.target;
                var originalText = btn.textContent;
                btn.textContent = '‚úì Copied!';
                btn.style.background = '#4CAF50';

                setTimeout(function () {
                    btn.textContent = originalText;
                    btn.style.background = '#667eea';
                }, 2000);
            });
        }

        // Timer countdown
        function updateTimer() {
            if (remainingSeconds <= 0) {
                document.getElementById('timer-display').textContent = 'EXPIRED';
                document.getElementById('timer-display').style.color = '#c62828';
                alert('Room has expired! Files will be deleted.');
                window.location.href = '/';
                return;
            }

            var minutes = Math.floor(remainingSeconds / 60);
            var seconds = remainingSeconds % 60;
            document.getElementById('timer-display').textContent =
                minutes + ':' + (seconds < 10 ? '0' : '') + seconds;

            if (remainingSeconds <= 120) {
                document.getElementById('timer-display').style.color = '#f57c00';
                document.getElementById('timer-warning').style.display = 'block';
            }

            if (remainingSeconds <= 30) {
                document.getElementById('timer-display').style.color = '#c62828';
            }

            remainingSeconds--;
        }

        // Start timer
        setInterval(updateTimer, 1000);

        // Handle page unload
        window.addEventListener('beforeunload', function () {
            socket.emit('leave', { code: roomCode });
        });

        // Add CSS animations
        var style = document.createElement('style');
        style.textContent = '@keyframes slideIn { from { opacity: 0; transform: translateY(-20px); } to { opacity: 1; transform: translateY(0); } } @keyframes slideInRight { from { opacity: 0; transform: translateX(100px); } to { opacity: 1; transform: translateX(0); } } @keyframes slideOutRight { from { opacity: 1; transform: translateX(0); } to { opacity: 0; transform: translateX(100px); } }';
        document.head.appendChild(style);
    </script>
</body>

</html>